@startuml C4-Component-YDB-Integration
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

title Component Diagram: YDB Integration Layer (Database Client & Helpers)

Container_Boundary(ydb_integration, "YDB Integration Layer") {
    Component(ydb_client, "YDB Driver", "@ydbjs/core + @ydbjs/query (v6)", "Driver + query client for executing YQL (sessions handled by QueryService)")
    
    Component(ydb_helpers, "YDB Helpers", "TypeScript Module", "Vector serialization and payload conversion utilities")
    
    Component(schema_mgr, "Schema Manager", "TypeScript Module", "Ensures metadata table qdr__collections exists")
    
    Component(env_config, "Environment Config", "TypeScript Module", "Loads and validates environment variables via dotenv")
    
    Component(logger, "Pino Logger", "pino", "Structured JSON logging with configurable log level")
}

ContainerDb(ydb_database, "YDB Database", "Distributed SQL/NoSQL", "Stores metadata and vector data")

Rel(ydb_client, env_config, "Reads", "YDB_ENDPOINT, YDB_DATABASE")
Rel(ydb_client, ydb_database, "Connects to", "Driver.ready(), credentials provider")

Rel(ydb_helpers, ydb_client, "Uses", "@ydbjs/value types for query parameters")

Rel(schema_mgr, ydb_client, "Uses", "withSession() to check/create table")
Rel(schema_mgr, logger, "Logs to", "Table creation events")

note right of ydb_client
  **Driver Initialization:**
  - @ydbjs/core Driver + @ydbjs/query query(driver)
  - Config: { endpoint, database, credentialsProvider }
  
  **Session Management:**
  - withSession<T>(fn)
  - Sessions are created/attached per query by @ydbjs/query
  
  **Auth Chain (first match):**
  1. YDB_SERVICE_ACCOUNT_KEY_FILE_CREDENTIALS
  2. YDB_METADATA_CREDENTIALS (YC VM/Functions)
  3. YDB_ACCESS_TOKEN_CREDENTIALS
  4. YDB_ANONYMOUS_CREDENTIALS (dev only)
  
  **Ready Check:**
  - readyOrThrow() â†’ 10s timeout
  - Throws if driver not ready
end note

note left of ydb_helpers
  **buildVectorBinaryParams(vec):**
  - Returns { float, bit } binary buffers for Knn::* functions
end note

note bottom of schema_mgr
  **ensureMetaTable():**
  1. CREATE TABLE qdr__collections (ignore exists errors)
  2. Probe required columns via SELECT ... LIMIT 0
  3. If missing column and automigrate enabled: ALTER TABLE ... ADD COLUMN ...
end note

note top of env_config
  **Required:**
  - YDB_ENDPOINT (string)
  - YDB_DATABASE (string)
  
  **Optional (Server):**
  - PORT (default 8080)
  - LOG_LEVEL (default "info")
  
  **Optional (Search):**
  - YDB_QDRANT_SEARCH_MODE (exact|approximate, default "exact")
  - YDB_QDRANT_OVERFETCH_MULTIPLIER (default 10)
  - YDB_QDRANT_SEARCH_TIMEOUT_MS (default 10000)
  
  **Optional (Upsert):**
  - YDB_QDRANT_UPSERT_BATCH_SIZE (default 100)
  - YDB_QDRANT_UPSERT_TIMEOUT_MS (default 5000)
  
  **Optional (Session Pool):**
  - YDB_SESSION_POOL_MIN_SIZE (default 5)
  - YDB_SESSION_POOL_MAX_SIZE (default 100)
  - YDB_SESSION_KEEPALIVE_PERIOD_MS (default 5000)
  
  **Optional (Migration):**
  - YDB_QDRANT_GLOBAL_POINTS_AUTOMIGRATE (default false)
  - YDB_QDRANT_USE_BATCH_DELETE (default false)
  
  **Optional (Tracking):**
  - YDB_QDRANT_LAST_ACCESS_MIN_WRITE_INTERVAL_MS (default 60000)
end note

note right of logger
  **Configuration:**
  - Level from LOG_LEVEL env var
  - JSON structured logs (pino format)
  
  **Common Fields:**
  - method, url, tenant
  - status, ms (response time)
  - err (error details when applicable)
  
  **Usage:**
  - logger.info/warn/error/debug
  - Middleware logs all requests/responses
end note

@enduml