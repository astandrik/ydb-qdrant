@startuml C4_Container
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title Container Diagram for YDB-Qdrant Service

Person(developer, "AI Coding Tool User", "Developer using Roo Code, Cline, or other Qdrant-compatible AI coding assistants")

System_Boundary(ydbQdrant, "YDB-Qdrant Service") {
    Container(webApp, "REST API Server", "Node.js, Express", "Exposes Qdrant-compatible HTTP API endpoints for vector operations")
    
    Container(routes, "HTTP Routes", "Express Router", "Handles collections and points endpoints with tenant isolation via X-Tenant-Id header")
    
    Container(repos, "Repository Layer", "TypeScript", "Business logic for collections and points operations; builds YQL queries for one-table layout")
    
    Container(ydbClient, "YDB Client", "@ydbjs/core + @ydbjs/query (v6)", "Database driver + query client (sessions managed by query service)")
}

ContainerDb(ydb, "YDB Database", "Distributed SQL/NoSQL", "Stores collection metadata (qdr__collections) and vector data (qdrant_all_points) with auto-partitioning")

Rel(developer, webApp, "Makes API requests", "HTTPS/REST")
Rel(webApp, routes, "Routes requests to", "Function calls")
Rel(routes, repos, "Delegates operations to", "Function calls")
Rel(repos, ydbClient, "Executes queries via", "YQL/SDK")
Rel(ydbClient, ydb, "Manages connections and sessions", "gRPC/YDB Protocol")

note right of webApp
  **Startup sequence:**
  1. readyOrThrow() - DB check
  2. ensureMetaTable() - schema
  3. Start Express on port 8080
  
  **Middleware:**
  • JSON parser (20MB limit)
  • Request logger (Pino)
end note

note right of routes
  **Collections endpoints:**
  • PUT/GET/DELETE /:collection
  • PUT /:collection/index (no-op)
  
  **Points endpoints:**
  • POST /:collection/points/upsert
  • POST /:collection/points/search
  • POST /:collection/points/delete
  
  **Compatibility aliases:**
  • PUT /:collection/points → upsert
  • POST /:collection/points/query → search
end note

note right of repos
  **Collections Repository:**
  • createCollection() - metadata only (one-table layout)
  • getCollectionMeta() - read metadata
  • deleteCollection() - delete from global table + metadata
  
  **Points Repository:**
  • upsertPoints() - with dimension check and batched UPSERT into qdrant_all_points
  • searchPoints() - exact or approximate KNN over serialized vectors in qdrant_all_points
  • deletePoints() - by point IDs within tenant/collection uid
  
  **Vector serialization:**
  Knn::ToBinaryStringFloat / Knn::ToBinaryStringBit
end note


note right of ydbClient
  **Session management:**
  • withSession(fn)
  • Sessions managed by @ydbjs/query (QueryService)
  
  **Auth methods (first match):**
  1. Service account key file
  2. Metadata service (YC VM)
  3. Access token (short-lived)
  4. Anonymous (dev only)
end note

note right of ydb
  **Tables:**
  • qdr__collections (metadata)
    PK: collection (tenant/name)
    Columns: table_name, vector_dimension, distance, vector_type, created_at, last_accessed_at
  • qdrant_all_points (global points table)
    PK: (uid, point_id)
    Columns: embedding (float binary), embedding_quantized (bit binary), payload
    Auto-partitioning: by load + by size (100MB)
  
  **Search modes (YDB_QDRANT_SEARCH_MODE):**
  • exact (default): single-phase KNN over embedding
  • approximate: bit-quantized candidates + exact re-ranking
  
  **Distance metrics:**
  Cosine, Euclid, Dot, Manhattan
end note

SHOW_LEGEND()

@enduml