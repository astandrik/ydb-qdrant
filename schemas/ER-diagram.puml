@startuml ER_Diagram
!define TABLE_BACKGROUND #E8F4F8
!define PK_BACKGROUND #FFE4B5

hide circle
skinparam linetype ortho
skinparam class {
    BackgroundColor TABLE_BACKGROUND
    BorderColor Black
    ArrowColor Blue
}

title Entity Relationship Diagram for YDB-Qdrant Service\n(Physical Data Model - YDB Tables)

entity "qdr__collections" as collections <<Metadata Table>> {
  * collection : Utf8 <<PK>>  // "<tenant>/<collection>"
  --
  table_name : Utf8          // always "qdrant_all_points" in one-table layout
  vector_dimension : Uint32
  distance : Utf8 {Cosine|Euclid|Dot|Manhattan}
  vector_type : Utf8 {float}
  created_at : Timestamp
}

entity "qdrant_all_points" as global_points <<Global Points Table>> {
  * uid : Utf8 <<PK>>        // derived from tenant + collection (uidFor)
  * point_id : Utf8 <<PK>>
  --
  embedding : String (binary, full-precision)
  embedding_quantized : String (binary, bit-quantized)
  payload : JsonDocument
}

collections ||--o{ global_points : "groups points via uid (tenant/collection)"

note right of collections
  **Primary Key Format:**
  collection = "<tenant>/<collection>"
  
  **Examples:**
  • "default/my_vectors"
  • "user123/embeddings"
  
  Tenant/collection names are 
  sanitized to [a-z0-9_]
end note

note right of global_points
  **uid Convention:**
  uid = uidFor(tenant, collection)
  
  **Embedding Storage:**
  • embedding: Binary string via Knn::ToBinaryStringFloat
  • embedding_quantized: Binary string via Knn::ToBinaryStringBit
  
  **Search:**
  • Exact: KNN over embedding
  • Approximate: candidates from embedding_quantized + re‑ranking over embedding
end note

legend right
  **Cardinality:**
  • One qdr__collections row ↔ many rows in qdrant_all_points sharing the same uid
  
  **Data Types:**
  • Utf8 = String
  • String (binary) = Binary byte array
  • JsonDocument = Arbitrary JSON structure
  • Timestamp = DateTime with timezone
  
  **Sources:**
  • PlantUML ER: https://plantuml.com/er-diagram
  • YDB Types: https://ydb.tech/docs/en/yql/reference/types/
endlegend

@enduml