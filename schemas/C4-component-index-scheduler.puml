@startuml C4-Component-Index-Scheduler
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

title Component Diagram: Index Scheduler (Deferred Vector Index Building)

Container_Boundary(index_scheduler, "Index Scheduler") {
    Component(scheduler_state, "Scheduler State", "In-Memory Object", "Per-collection tracking: lastUpsertMs, timer, pending flag, pointsUpserted counter")
    
    Component(notify_upsert, "notifyUpsert()", "Function", "Called after each point upsert to increment counter and update timestamp")
    
    Component(request_build, "requestIndexBuild()", "Function", "Schedules deferred index build with quiet window logic and threshold checks")
    
    Component(timer_logic, "Timer Logic", "setTimeout", "Waits for quiet window (10s) before attempting index build")
    
    Component(threshold_gate, "Threshold Gate", "Logic Component", "Verifies ≥100 points upserted before proceeding with build")
}

Container(collections_repo, "Collections Repository", "TypeScript Module", "Provides buildVectorIndex()")
Container(logger, "Pino Logger", "pino", "Logs build events")

Rel(notify_upsert, scheduler_state, "Updates", "Increments pointsUpserted, sets lastUpsertMs")

Rel(request_build, scheduler_state, "Reads/Writes", "Checks pending flag, schedules timer")
Rel(request_build, timer_logic, "Schedules", "setTimeout(tryBuild, QUIET_MS)")

Rel(timer_logic, scheduler_state, "Checks", "Verifies quiet window elapsed")
Rel(timer_logic, threshold_gate, "Delegates to", "If quiet window passed")

Rel(threshold_gate, scheduler_state, "Reads", "pointsUpserted count")
Rel(threshold_gate, collections_repo, "Calls", "buildVectorIndex() if threshold met")
Rel(threshold_gate, logger, "Logs to", "Build started/completed/skipped")

Rel(collections_repo, logger, "Logs to", "Build errors")

note right of scheduler_state
  **State Structure (per table):**
  {
    lastUpsertMs: number,
    timer?: NodeJS.Timeout,
    pending: boolean,
    pointsUpserted: number
  }
  
  **Key (CollectionKey):**
  - Table name (qdr_tenant__collection)
  - Unique per tenant+collection pair
end note

note left of notify_upsert
  **Called By:**
  - pointsRepo.upsertPoints() after each point
  
  **Actions:**
  1. Get/create state for tableName
  2. Set lastUpsertMs = Date.now()
  3. Increment pointsUpserted by count
  4. Update state[tableName]
  
  **Purpose:**
  - Track upsert activity per collection
  - Feed into quiet window detection
end note

note right of request_build
  **Parameters:**
  - tableName, dimension, distance, vectorType
  - opts?: { force?: boolean }
  
  **Force Mode:**
  - Bypasses quiet window and threshold
  - Immediate buildVectorIndex() call
  
  **Normal Mode Flow:**
  1. Check if already pending → return (no double-schedule)
  2. Set pending=true
  3. Schedule timer with tryBuild() callback
  
  **tryBuild() Logic:**
  1. Check elapsed time since lastUpsertMs
  2. If < QUIET_MS → reschedule for remaining time
  3. If >= QUIET_MS → check threshold
  4. If pointsUpserted < 100 → skip, log, clear state
  5. If >= 100 → call buildVectorIndex()
     - On success: reset pointsUpserted to 0
     - On error: log error
     - Finally: clear pending and timer
end note

note bottom of threshold_gate
  **Constants:**
  - QUIET_MS = 10000 (10 seconds)
  - MIN_POINTS_THRESHOLD = 100
  
  **Logic:**
  if (pointsUpserted >= 100) {
    buildVectorIndex()
  } else {
    log "skipped (below threshold)"
  }
  
  **Rationale:**
  - Avoid index rebuild overhead for small batches
  - Optimize for bulk import scenarios
  - Balance index freshness vs. system load
end note

note top of timer_logic
  **Quiet Window Algorithm:**
  1. Initial delay: QUIET_MS (10s)
  2. On timer fire:
     - Calculate elapsed = now - lastUpsertMs
     - If elapsed < QUIET_MS:
       * Reschedule: setTimeout(tryBuild, QUIET_MS - elapsed)
       * (More upserts arrived; reset window)
     - Else:
       * Proceed to threshold check
  
  **Purpose:**
  - Debounce index builds during active upserts
  - Ensure index builds happen after batch completion
  - Prevent redundant rebuilds
end note

@enduml