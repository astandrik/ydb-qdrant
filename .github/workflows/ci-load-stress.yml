name: Load test (stress)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  stress_test:
    name: Stress test (${{ matrix.storage_mode }}, mode=${{ matrix.search_mode }}, ramping load)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - storage_mode: multi_table
            search_mode: approximate
          - storage_mode: one_table
            search_mode: approximate
          - storage_mode: one_table
            search_mode: exact

    services:
      ydb:
        image: ghcr.io/ydb-platform/local-ydb:stable-25-3
        ports:
          - 2136:2136
        options: --hostname localhost

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Wait for YDB to be ready
        run: |
          echo "Waiting for YDB at grpc://localhost:2136 ..."
          for i in {1..30}; do
            if nc -z localhost 2136; then
              echo "YDB is accepting connections on port 2136"
              exit 0
            fi
            echo "YDB not ready yet, retrying..."
            sleep 2
          done
          echo "YDB did not become ready in time"
          exit 1

      - name: Start HTTP server
        run: |
          npm start &
          echo $! > server.pid
          sleep 5
        env:
          YDB_ENDPOINT: grpc://localhost:2136
          YDB_DATABASE: /local
          YDB_ANONYMOUS_CREDENTIALS: "1"
          YDB_QDRANT_COLLECTION_STORAGE_MODE: ${{ matrix.storage_mode }}
          YDB_QDRANT_SEARCH_MODE: ${{ matrix.search_mode }}
          PORT: 8080
          LOG_LEVEL: warn

      - name: Wait for server health
        run: |
          echo "Waiting for server health at http://localhost:8080/health ..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/health | grep -q '"status":"ok"'; then
              echo "Server is healthy"
              exit 0
            fi
            echo "Server not ready yet, retrying..."
            sleep 2
          done
          echo "Server did not become healthy in time"
          exit 1

      - name: Run stress test (CI breaking point search)
        run: |
          node loadtest/BreakingPointRunner.js 2>&1 | tee stress.log
          # k6 (via BreakingPointRunner) outputs benchmark JSON to ./stress-benchmark*.json via handleSummary
        env:
          BASE_URL: http://localhost:8080
          # Bounds and parameters for CI-only breaking-point exploration
          BREAK_MIN_VUS: 100
          BREAK_MAX_VUS: 1500
          BREAK_ERROR_THRESHOLD: 5
          # Treat very high latency as breaking, even if error rate stays low
          BREAK_P95_MS: 4000
          BREAK_MAX_RUNS: 5
          # Shorter fixed duration per step to keep CI time reasonable
          FIXED_DURATION: "1m"
        # Don't fail on k6 threshold violations - stress test is informational
        continue-on-error: true

      - name: Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          name: "Load Test - Stress (${{ matrix.storage_mode }}, 768D)"
          tool: "customSmallerIsBetter"
          output-file-path: stress-benchmark.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: "150%"
          comment-on-alert: true
          fail-on-alert: false
          # Store results in gh-pages branch under ./dev/bench
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench

      - name: Store capacity benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          name: "Load Test - Stress Capacity (${{ matrix.storage_mode }}, 768D)"
          tool: "customBiggerIsBetter"
          output-file-path: stress-benchmark-capacity.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          alert-threshold: "150%"
          comment-on-alert: true
          fail-on-alert: false
          # Store results in gh-pages branch under ./dev/bench
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench

      - name: Make benchmark charts more compact on gh-pages
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          set -e

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Ensure we have the latest gh-pages branch locally
          git fetch origin gh-pages:gh-pages || git fetch origin gh-pages
          git switch gh-pages || git checkout gh-pages

          INDEX_PATH="dev/bench/index.html"
          if [ ! -f "$INDEX_PATH" ]; then
            echo "No $INDEX_PATH found on gh-pages; skipping compact layout tweak"
            exit 0
          fi

          if grep -q 'id=\"ydb-qdrant-bench-compact\"' "$INDEX_PATH"; then
            echo "Compact benchmark style already present; nothing to do"
          else
            echo "Injecting compact benchmark style into $INDEX_PATH"
            tmpfile="$(mktemp)"
            awk '
              /<\/head>/ && !done {
                print "  <style id=\"ydb-qdrant-bench-compact\">"
                print "    body canvas {"
                print "      max-height: 320px !important;"
                print "    }"
                print "  </style>"
                done = 1
              }
              { print }
            ' "$INDEX_PATH" > "$tmpfile"
            mv "$tmpfile" "$INDEX_PATH"
          fi

          git add "$INDEX_PATH"
          git commit -m "Make benchmark charts more compact [skip ci]" || echo "No changes to commit"
          git push origin gh-pages || echo "Failed to push gh-pages (possibly from a fork)"

      - name: Compare benchmark results (PR)
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name == 'pull_request'
        # Skip gracefully if gh-pages branch doesn't exist yet (first run)
        continue-on-error: true
        with:
          name: "Load Test - Stress (${{ matrix.storage_mode }}, 768D)"
          tool: "customSmallerIsBetter"
          output-file-path: stress-benchmark.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: false
          alert-threshold: "150%"
          comment-on-alert: true
          fail-on-alert: false
          # Compare against results in gh-pages branch
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench

      - name: Compare capacity benchmark results (PR)
        uses: benchmark-action/github-action-benchmark@v1
        if: github.event_name == 'pull_request'
        # Skip gracefully if gh-pages branch doesn't exist yet (first run)
        continue-on-error: true
        with:
          name: "Load Test - Stress Capacity (${{ matrix.storage_mode }}, 768D)"
          tool: "customBiggerIsBetter"
          output-file-path: stress-benchmark-capacity.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: false
          alert-threshold: "150%"
          comment-on-alert: true
          fail-on-alert: false
          # Compare against results in gh-pages branch
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench

      - name: Extract metrics
        id: metrics
        run: |
          MAX_VUS=$(grep 'STRESS_MAX_VUS' stress.log | tail -1 | sed -E 's/.*STRESS_MAX_VUS (-?[0-9.]+).*/\1/')
          AVG_RPS=$(grep 'STRESS_AVG_RPS' stress.log | tail -1 | sed -E 's/.*STRESS_AVG_RPS ([0-9.]+).*/\1/')
          SEARCH_P95=$(grep 'STRESS_SEARCH_P95' stress.log | tail -1 | sed -E 's/.*STRESS_SEARCH_P95 ([0-9.]+).*/\1/')
          SEARCH_P99=$(grep 'STRESS_SEARCH_P99' stress.log | tail -1 | sed -E 's/.*STRESS_SEARCH_P99 ([0-9.]+).*/\1/')
          ERROR_RATE=$(grep 'STRESS_ERROR_RATE' stress.log | tail -1 | sed -E 's/.*STRESS_ERROR_RATE ([0-9.]+).*/\1/')
          BREAKING_VUS=$(grep 'STRESS_BREAKING_POINT_VUS' stress.log | tail -1 | sed -E 's/.*STRESS_BREAKING_POINT_VUS (-?[0-9.]+).*/\1/')
          BREAKING_RPS=$(grep 'STRESS_BREAKING_POINT_RPS' stress.log | tail -1 | sed -E 's/.*STRESS_BREAKING_POINT_RPS ([0-9.]+).*/\1/')

          echo "max_vus=${MAX_VUS}" >> "$GITHUB_OUTPUT"
          echo "avg_rps=${AVG_RPS}" >> "$GITHUB_OUTPUT"
          echo "search_p95=${SEARCH_P95}" >> "$GITHUB_OUTPUT"
          echo "search_p99=${SEARCH_P99}" >> "$GITHUB_OUTPUT"
          echo "error_rate=${ERROR_RATE}" >> "$GITHUB_OUTPUT"
          echo "breaking_vus=${BREAKING_VUS}" >> "$GITHUB_OUTPUT"
          echo "breaking_rps=${BREAKING_RPS}" >> "$GITHUB_OUTPUT"

          echo "### Stress Test Results (${{ matrix.storage_mode }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Max VUs reached | ${MAX_VUS} |" >> $GITHUB_STEP_SUMMARY
          echo "| Average RPS | ${AVG_RPS} |" >> $GITHUB_STEP_SUMMARY
          echo "| Search p95 | ${SEARCH_P95}ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Search p99 | ${SEARCH_P99}ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Error rate | ${ERROR_RATE}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Breaking Point" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$BREAKING_VUS" = "-1" ]; then
            echo "✅ No breaking point detected - system handled all load levels" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Breaking point detected at ${BREAKING_VUS} VUs (${BREAKING_RPS} RPS)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update PR description with stress load test results
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          STORAGE_MODE: ${{ matrix.storage_mode }}
          MAX_VUS: ${{ steps.metrics.outputs.max_vus }}
          AVG_RPS: ${{ steps.metrics.outputs.avg_rps }}
          SEARCH_P95: ${{ steps.metrics.outputs.search_p95 }}
          SEARCH_P99: ${{ steps.metrics.outputs.search_p99 }}
          ERROR_RATE: ${{ steps.metrics.outputs.error_rate }}
          BREAKING_VUS: ${{ steps.metrics.outputs.breaking_vus }}
          BREAKING_RPS: ${{ steps.metrics.outputs.breaking_rps }}
        run: |
          EXISTING_BODY="$(gh api repos/${{ github.repository }}/pulls/${PR_NUMBER} --jq '.body // ""')"

          LOAD_BLOCK="$(cat <<EOF | sed 's/^          //'
          ### Load test (stress, ${STORAGE_MODE})

          | Metric | Value |
          |--------|-------|
          | Max VUs reached | ${MAX_VUS} |
          | Average RPS | ${AVG_RPS} |
          | Search p95 | ${SEARCH_P95} ms |
          | Search p99 | ${SEARCH_P99} ms |
          | Error rate | ${ERROR_RATE} % |

          #### Breaking point

          $(if [ "${BREAKING_VUS}" = "-1" ]; then \
            echo "No breaking point detected within the tested range."; \
          else \
            echo "Breaking point detected at **${BREAKING_VUS} VUs** (~${BREAKING_RPS} RPS)."; \
          fi)
          EOF
          )"

          export EXISTING_BODY
          export LOAD_BLOCK
          export STORAGE_MODE
          NEW_BODY="$(node -e '
            const body = process.env.EXISTING_BODY || "";
            const block = process.env.LOAD_BLOCK || "";
            const storageMode = process.env.STORAGE_MODE || "";
            const heading = "### Load test (stress, " + storageMode + ")";
            let newBody;
            if (body.includes(heading)) {
              // Replace existing block (handles both start-of-string and mid-string)
              const escapedHeading = heading.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
              const pattern = new RegExp("(^|\\n)" + escapedHeading + "[\\s\\S]*?(?=\\n### Load test \\(|$)");
              newBody = body.replace(pattern, "$1" + block);
            } else {
              // Append to end
              newBody = body ? body.trimEnd() + "\n\n" + block + "\n" : block + "\n";
            }
            process.stdout.write(newBody);
          ')"

          gh api \
            repos/${{ github.repository }}/pulls/${PR_NUMBER} \
            -X PATCH \
            -f body="$NEW_BODY"

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-log-${{ matrix.storage_mode }}-${{ matrix.search_mode }}
          path: stress.log
          retention-days: 7
