name: Recall tests

on:
  push:
  pull_request:

jobs:
  recall_tests:
    name: Semantic recall tests (one_table)
    runs-on: ubuntu-latest
    permissions:
      contents: write

    services:
      ydb:
        image: ghcr.io/ydb-platform/local-ydb:stable-25-3
        ports:
          - 2136:2136
        options: --hostname localhost

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: Wait for YDB to be ready
        run: |
          echo "Waiting for YDB at grpc://localhost:2136 ..."
          for i in {1..30}; do
            if nc -z localhost 2136; then
              echo "YDB is accepting connections on port 2136"
              exit 0
            fi
            echo "YDB not ready yet, retrying..."
            sleep 2
          done
          echo "YDB did not become ready in time"
          exit 1

      - name: Run recall tests
        run: npm run test:recall | tee recall.log
        env:
          YDB_ENDPOINT: grpc://localhost:2136
          YDB_DATABASE: /local
          YDB_ANONYMOUS_CREDENTIALS: "1"

      - name: Extract mean recall
        id: recall
        run: |
          ONE=$(grep 'RECALL_MEAN_ONE_TABLE' recall.log | tail -1 | awk '{print $2}')
          F1_ONE=$(grep 'F1_MEAN_ONE_TABLE' recall.log | tail -1 | awk '{print $2}')

          if [ -z "$ONE" ]; then
            echo "No one_table recall value found in logs"
            exit 1
          fi

          if [ -z "$F1_ONE" ]; then
            echo "No one_table F1 value found in logs"
            exit 1
          fi

          echo "mean_recall_one=$ONE" >> "$GITHUB_OUTPUT"
          echo "mean_f1_one=$F1_ONE" >> "$GITHUB_OUTPUT"

      - name: Publish recall badge JSON
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          ONE="${{ steps.recall.outputs.mean_recall_one }}"
          F1_ONE="${{ steps.recall.outputs.mean_f1_one }}"

          if [ -z "$ONE" ] || [ -z "$F1_ONE" ]; then
            echo "mean_recall_one or mean_f1_one output is empty"
            exit 1
          fi

          color_for_value () {
            local v="$1"
            if awk "BEGIN { exit !($v >= 0.8) }"; then
              echo "brightgreen"
            elif awk "BEGIN { exit !($v >= 0.6) }"; then
              echo "orange"
            else
              echo "red"
            fi
          }

          COLOR_ONE=$(color_for_value "$ONE")
          COLOR_F1_ONE=$(color_for_value "$F1_ONE")

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git fetch origin
          git checkout recall-badges || git checkout -b recall-badges
          git pull origin recall-badges || true

          # one_table badge JSON
          printf '{\n' > recall-one-table.json
          printf '  "schemaVersion": 1,\n' >> recall-one-table.json
          printf '  "label": "recall (one_table)",\n' >> recall-one-table.json
          printf '  "message": "%.3f",\n' "$ONE" >> recall-one-table.json
          printf '  "color": "%s"\n' "$COLOR_ONE" >> recall-one-table.json
          printf '}\n' >> recall-one-table.json

          # one_table F1 badge JSON
          printf '{\n' > f1-one-table.json
          printf '  "schemaVersion": 1,\n' >> f1-one-table.json
          printf '  "label": "F1 (one_table)",\n' >> f1-one-table.json
          printf '  "message": "%.3f",\n' "$F1_ONE" >> f1-one-table.json
          printf '  "color": "%s"\n' "$COLOR_F1_ONE" >> f1-one-table.json
          printf '}\n' >> f1-one-table.json

          git add recall-one-table.json f1-one-table.json
          git commit -m "Update recall badge [skip ci]" || echo "No changes to commit"
          git push origin recall-badges || echo "Failed to push recall-badges (likely from a fork PR)"

